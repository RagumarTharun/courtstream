<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CourtStream</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background:#0f1115;
  color:#eee;
  font-family:system-ui;
  margin:0;
}
.container {
  max-width:720px;
  margin:60px auto;
  padding:20px;
}
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.muted { color:#aaa; margin-bottom:24px; }
.user { color:#aaa; font-size:14px; }

button {
  padding:8px 12px;
  border-radius:8px;
  border:none;
  background:#ff3b3b;
  color:white;
  cursor:pointer;
  font-size:14px;
}
button.secondary { background:#333; }

input {
  width:100%;
  padding:14px;
  border-radius:10px;
  border:none;
  font-size:16px;
  margin-bottom:16px;
}

.streams {
  display:flex;
  flex-direction:column;
  gap:10px;
}
.stream {
  padding:14px;
  background:#161922;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.stream-actions {
  display:flex;
  gap:8px;
}
.empty { color:#888; margin-top:20px; }
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div>
      <h1 id="greeting">Welcome to CourtStream</h1>
      <div class="muted" id="subtext">
        Discover live sports streams or create your own.
      </div>
    </div>
    <div class="user" id="userInfo"></div>
  </div>

  <div id="authActions" style="margin-bottom:20px;"></div>

  <input id="search" placeholder="Search streams" autocomplete="off" />

  <div class="streams" id="streamList"></div>
  <div class="empty" id="emptyState" style="display:none;">
    No streams found.
  </div>

</div>

<script>
let allStreams = [];
let currentUser = null;

/* STREAMS */
async function loadStreams(){
  const res = await fetch("/api/streams");
  allStreams = await res.json();
  render();
}

/* AUTH */
(async () => {
  try {
    const res = await fetch("/me", { credentials:"include" });
    if (!res.ok) throw 0;

    currentUser = await res.json();

    greeting.innerText = `Hello ${currentUser.email}`;
    subtext.innerText = "Pick a stream to join or direct.";
    userInfo.innerText = currentUser.email;

    authActions.innerHTML = `
      <button onclick="location.href='create.html'">+ Create Stream</button>
      <button class="secondary" onclick="logout()">Logout</button>
    `;

    render(); // ðŸ”‘ RE-RENDER AFTER AUTH

  } catch {
    authActions.innerHTML = `
      <button onclick="alert('Login required')">+ Create Stream</button>
      <button class="secondary" onclick="location.href='login.html'">Login</button>
      <button class="secondary" onclick="location.href='register.html'">Register</button>
    `;
  }
})();

/* RENDER */
function render(){
  const box = document.getElementById("streamList");
  box.innerHTML = "";

  if (!allStreams.length) {
    emptyState.style.display = "block";
    return;
  }
  emptyState.style.display = "none";

  allStreams.forEach(s => {
    const row = document.createElement("div");
    row.className = "stream";

    row.innerHTML = `
      <strong>${s.name}</strong>
      <div class="stream-actions">
        <button class="secondary" onclick="viewStream('${s.id}')">View</button>
        <button class="secondary" onclick="camStream('${s.id}')">Cam</button>
        ${
          currentUser && s.creator === currentUser.id
            ? `<button onclick="direct('${s.id}')">Direct</button>`
            : ""
        }
      </div>
    `;

    box.appendChild(row);
  });
}

function viewStream(id){
  location.href = `viewer.html?stream=${id}`;
}
function camStream(id){
  const stream = allStreams.find(s => s.id === id);
  const name = stream ? encodeURIComponent(stream.name) : "";
  const nameParam = name ? `&name=${name}` : "";
  location.href = `camera-live.html?stream=${id}${nameParam}`;
}
function direct(id){
  const stream = allStreams.find(s => s.id === id);
  const name = stream ? encodeURIComponent(stream.name) : "";
  const nameParam = name ? `&name=${name}` : "";
  location.href = `director.html?stream=${id}${nameParam}`;
}

search.oninput = e => {
  const q = e.target.value.toLowerCase();
  render(allStreams.filter(s => s.name.toLowerCase().includes(q)));
};

async function logout(){
  await fetch("/logout",{method:"POST",credentials:"include"});
  location.reload();
}

loadStreams();
</script>
</body>
</html>
