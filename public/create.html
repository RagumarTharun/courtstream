<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Create Stream â€“ CourtStream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #0f1115;
      --panel: #161922;
      --border: #262b3d;
      --text: #e6e6eb;
      --muted: #9aa0b4;
      --blue: #3b82f6;
      --red: #ef4444;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      max-width: 420px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 24px;
      padding: 0;
      line-height: 1;
    }

    .close-btn:hover {
      color: var(--text);
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 15px;
      outline: none;
      margin-bottom: 20px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    input:focus,
    select:focus {
      border-color: var(--blue);
    }

    button.primary {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: var(--blue);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    button.primary:hover {
      opacity: 0.9;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-box {
      background: var(--panel);
      border-radius: 14px;
      padding: 24px;
      width: 320px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .modal-box p {
      margin: 0 0 20px;
      font-size: 15px;
    }

    .modal-box button {
      background: var(--blue);
      color: white;
      border: none;
      padding: 8px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    /* NEW THUMB STYLES */
    .thumb-upload {
      width: 100%;
      aspect-ratio: 16/9;
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      margin-bottom: 20px;
      transition: border-color 0.2s;
    }

    .thumb-upload:hover {
      border-color: var(--blue);
    }
  </style>
</head>

<body>

  <div class="card">
    <div class="header">
      <h2>Create New Stream</h2>
      <button class="close-btn" onclick="location.href='index.html'">&times;</button>
    </div>

    <label>Stream Name</label>
    <input id="nameInput" placeholder="e.g. Championship Finals Game 1" autofocus>

    <label style="margin-top:20px;">Stream Access (Security)</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
      <div>
        <label style="font-size:12px;color:var(--muted);">Camera Access</label>
        <select id="cameraAccess">
          <option value="public" selected>Public</option>
          <option value="protected">Protected</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;color:var(--muted);">Viewer Access</label>
        <select id="viewerAccess">
          <option value="public" selected>Public</option>
          <option value="protected">Protected</option>
        </select>
      </div>
    </div>

    <div id="passwordSection" style="display:none;margin-bottom:20px;">
      <label>Stream Passcode</label>
      <input type="password" id="streamPassword" placeholder="Enter a 4-digit passcode" maxlength="20">
      <div style="font-size:11px;color:var(--muted);margin-top:4px;">This password will be required for cameras or
        viewers to join.</div>
    </div>

    <button id="createBtn" class="primary">Start Stream</button>
  </div>

  <!-- ERROR MODAL -->
  <div class="modal" id="modal">
    <div class="modal-box">
      <p id="modalText"></p>
      <button onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    const nameInput = document.getElementById("nameInput");
    const createBtn = document.getElementById("createBtn");
    const modal = document.getElementById("modal");
    const modalText = document.getElementById("modalText");

    function showError(msg) {
      modalText.innerText = msg;
      modal.style.display = "flex";
    }

    function closeModal() {
      modal.style.display = "none";
      nameInput.focus();
    }

    /* AUTH CHECK */
    (async () => {
      const res = await fetch("/me", { credentials: "include" });
      if (!res.ok) location.href = "login.html";
    })();

    const cameraAccess = document.getElementById("cameraAccess");
    const viewerAccess = document.getElementById("viewerAccess");
    const passwordSection = document.getElementById("passwordSection");
    const streamPassword = document.getElementById("streamPassword");

    function checkPassVisibility() {
      if (cameraAccess.value === "protected" || viewerAccess.value === "protected") {
        passwordSection.style.display = "block";
      } else {
        passwordSection.style.display = "none";
      }
    }

    cameraAccess.onchange = checkPassVisibility;
    viewerAccess.onchange = checkPassVisibility;

    /* CREATE LOGIC */
    createBtn.onclick = async () => {
      const name = nameInput.value.trim();
      const pass = streamPassword.value.trim();

      if (name.length < 3) {
        showError("Stream name must be at least 3 characters.");
        return;
      }

      if (passwordSection.style.display === "block" && pass.length < 4) {
        showError("Passcode must be at least 4 characters.");
        return;
      }

      createBtn.disabled = true;
      createBtn.innerText = "Creating...";

      try {
        const res = await fetch("/api/streams", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            camera_access: cameraAccess.value,
            viewer_access: viewerAccess.value,
            password: pass
          })
        });

        if (!res.ok) {
          let errorMsg = "Failed to create stream";
          try {
            const data = await res.json();
            errorMsg = data.error || errorMsg;
          } catch (e) {
            // Fallback for non-JSON errors (like 401 Unauthorized text)
            if (res.status === 401) errorMsg = "Session expired. Please log in again.";
          }
          throw new Error(errorMsg);
        }

        // Success
        const data = await res.json();
        location.href = `director.html?stream=${data.id}&name=${encodeURIComponent(name)}`;

      } catch (err) {
        createBtn.disabled = false;
        createBtn.innerText = "Start Stream";
        showError(err.message === "exists" ? "Name already taken" : "Failed to create stream");
      }
    };
  </script>

</body>

</html>