<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>CourtStream ‚Äì Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='2'><circle cx='12' cy='12' r='10'/><path d='M9.5 8l6 4-6 4V8z' fill='white' stroke='none'/></svg>">

  <style>
    :root {
      --bg: #0f1115;
      --panel: #161922;
      --border: #262b3d;
      --text: #e6e6eb;
      --muted: #9aa0b4;
      --blue: #3b82f6;
      --red: #ef4444;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== LAYOUT ===== */
    .viewer-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ===== PLAYER (LEFT/TOP) ===== */
    .player-container {
      flex: 1;
      background: #000;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* ===== CHAT (RIGHT/BOTTOM) ===== */
    .chat-container {
      width: 350px;
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .chat-header {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .viewer-count {
      background: #262b3d;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
    }

    .msg-name {
      font-weight: 700;
      color: var(--blue);
      margin-right: 4px;
    }

    .chat-input-area {
      padding: 14px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      color: #fff;
      padding: 8px 12px;
      border-radius: 20px;
      outline: none;
    }

    .send-btn {
      background: var(--blue);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
    }

    /* ===== OVERLAYS & UI ===== */
    .stream-info {
      position: absolute;
      top: 14px;
      left: 14px;
      z-index: 10;
    }

    .badge {
      background: rgba(0, 0, 0, 0.6);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--red);
      border-radius: 50%;
    }

    /* REACTION FLOATING BUTTONS */
    .reaction-bar {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }

    .react-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(4px);
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.1s, background 0.2s;
    }

    .react-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .react-btn:active {
      transform: scale(0.9);
    }

    /* ANIMATED REACTIONS */
    .floating-emoji {
      position: absolute;
      bottom: 60px;
      right: 40px;
      font-size: 24px;
      pointer-events: none;
      animation: floatUp 2s ease-out forwards;
      z-index: 5;
    }

    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0) scale(0.5);
      }

      100% {
        opacity: 0;
        transform: translateY(-100px) scale(1.5);
      }
    }

    /* ===== MOBILE RWD ===== */
    @media (max-width: 900px) {
      .viewer-layout {
        flex-direction: column;
      }

      .player-container {
        flex: initial;
        width: 100%;
        aspect-ratio: 16/9;
      }

      .chat-container {
        width: 100%;
        flex: 1;
        border-left: none;
        border-top: 1px solid var(--border);
      }

      .reaction-bar {
        bottom: 10px;
        right: 10px;
      }

      .react-btn {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      /* Feedback Button overrides for Mobile */
      .feedback-fab {
        top: 20px !important;
        right: 86px !important;
        bottom: auto !important;
        width: 40px !important;
        height: 40px !important;
      }

      .feedback-fab svg {
        width: 18px !important;
        height: 18px !important;
      }
    }

    /* Feedback Button overrides for Desktop */
    @media (min-width: 901px) {
      .feedback-fab {
        top: 24px !important;
        right: 380px !important;
        bottom: auto !important;
      }
    }
  </style>
</head>

<body>

  <div class="viewer-layout">
    <!-- PLAYER -->
    <div class="player-container">
      <video id="v" autoplay muted playsinline></video>

      <div class="stream-info">
        <div class="badge">
          <div class="live-dot"></div>
          <span id="streamName">Live Stream</span>
        </div>
      </div>

      <div class="reaction-bar">
        <button class="react-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="react-btn" onclick="sendReaction('üî•')">üî•</button>
        <button class="react-btn" onclick="sendReaction('üëè')">üëè</button>
        <button class="react-btn" onclick="toggleFullscreen()">‚õ∂</button>
      </div>

      <!-- Container for flying emojis -->
      <div id="reactionContainer"></div>
    </div>

    <!-- CHAT -->
    <div class="chat-container">
      <div class="chat-header">
        <span>Live Chat</span>
        <div class="viewer-count">üë• <span id="viewCount">0</span></div>
      </div>
      <div class="chat-messages" id="msgs">
        <div class="msg" style="color:var(--muted);text-align:center;">Welcome to the chat!</div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" class="chat-input" placeholder="Say something..." maxlength="100">
        <button class="send-btn" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <!-- ENTRY / PASSCODE OVERLAYS (Reusing same logic structure) -->
  <div id="entryOverlay"
    style="position:fixed;inset:0;background:rgba(15,17,21,0.9);z-index:90;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:20px;text-align:center;">
    <button id="entryBtn"
      style="padding:16px 32px;background:var(--blue);border:none;border-radius:12px;font-weight:600;font-size:16px;color:white;cursor:pointer;">
      ‚ñ∂ Watch Stream
    </button>
  </div>

  <div id="passcodeOverlay"
    style="display:none;position:fixed;inset:0;background:rgba(15,17,21,0.95);z-index:100;align-items:center;justify-content:center;flex-direction:column;padding:20px;text-align:center;">
    <h3 style="margin-top:0;">Secured Stream</h3>
    <input type="password" id="passInput" placeholder="Enter Passcode"
      style="background:var(--bg);border:1px solid var(--border);color:#fff;padding:12px;border-radius:8px;width:100%;max-width:240px;text-align:center;font-size:18px;margin-bottom:16px;">
    <button id="joinBtn"
      style="padding:10px 24px;background:var(--blue);border:none;border-radius:8px;font-weight:600;color:white;cursor:pointer;">
      Join Stream
    </button>
    <div id="errorMsg" style="color:var(--red);font-size:12px;margin-top:12px;display:none;">Invalid passcode</div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="feedback.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const streamId = params.get("stream");
    const streamName = params.get("name") || "Stream";
    let myName = "Guest " + Math.floor(Math.random() * 1000);

    // Update UI
    document.getElementById("streamName").innerText = streamName;

    /* ===== CHAT & REACTIONS ===== */
    const msgs = document.getElementById("msgs");
    const chatInput = document.getElementById("chatInput");
    const reactionContainer = document.getElementById("reactionContainer");
    const viewCountEl = document.getElementById("viewCount");

    function sendMsg() {
      const text = chatInput.value.trim();
      if (!text) return;
      socket.emit("chat-message", { room: streamId, name: myName, text });
      chatInput.value = "";
    }

    chatInput.onkeydown = (e) => {
      if (e.key === "Enter") sendMsg();
    }

    socket.on("chat-message", ({ name, text }) => {
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span class="msg-name">${name}:</span> ${text}`; // Trusted text only? careful with xss, but this is a demo
      div.textContent = ""; // Safety first

      const nameSpan = document.createElement("span");
      nameSpan.className = "msg-name";
      nameSpan.innerText = name + ": ";

      const textSpan = document.createElement("span");
      textSpan.innerText = text;

      div.appendChild(nameSpan);
      div.appendChild(textSpan);

      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    });

    function sendReaction(type) {
      socket.emit("reaction", { room: streamId, type });
      showFloatingReaction(type); // Show local immediately
    }

    socket.on("reaction", ({ type }) => {
      showFloatingReaction(type);
    });

    socket.on("viewer-count", count => {
      viewCountEl.innerText = count;
    });

    function showFloatingReaction(char) {
      const el = document.createElement("div");
      el.className = "floating-emoji";
      el.innerText = char;
      // Randomize horizontal start slightly
      el.style.right = (20 + Math.random() * 40) + "px";
      reactionContainer.appendChild(el);
      setTimeout(() => el.remove(), 2000);
    }

    function toggleFullscreen() {
      const el = document.querySelector(".player-container");
      if (!document.fullscreenElement) el.requestFullscreen();
      else document.exitFullscreen();
    }

    /* ===== WEBRTC LOGIC (Existing) ===== */
    const video = document.getElementById("v");
    let pc;
    let turnConfig = null;
    let directorId = null;

    async function getTurnConfig() {
      if (turnConfig) return turnConfig;
      const res = await fetch("/api/turn-credentials");
      turnConfig = await res.json();
      return turnConfig;
    }

    // Access Gates
    const entryOverlay = document.getElementById("entryOverlay");
    document.getElementById("entryBtn").onclick = async () => {
      entryOverlay.style.display = "none";
      const config = await getTurnConfig();
      pc = new RTCPeerConnection(config);
      setupPeerHooks();
      checkAccess();
    };

    const passOverlay = document.getElementById("passcodeOverlay");
    const passInput = document.getElementById("passInput");
    const errorMsg = document.getElementById("errorMsg");

    document.getElementById("joinBtn").onclick = () => {
      const pass = passInput.value.trim();
      if (pass) socket.emit("join", { room: streamId, role: "viewer", password: pass });
    }

    async function checkAccess() {
      // ... (Similar logic to before, simplified)
      const res = await fetch("/api/streams");
      const all = await res.json();
      const stream = all.find(s => s.id === streamId);

      if (stream && stream.viewer_access === "protected") {
        passOverlay.style.display = "flex";
      } else {
        socket.emit("join", { room: streamId, role: "viewer" });
      }
    }

    socket.on("join-error", () => {
      passOverlay.style.display = "flex";
      errorMsg.style.display = "block";
    });

    socket.on("join-success", () => {
      passOverlay.style.display = "none";
    });

    function setupPeerHooks() {
      pc.ontrack = e => {
        const stream = e.streams[0] || new MediaStream([e.track]);
        video.srcObject = stream;
        video.play().catch(console.warn);
      };
      pc.onicecandidate = e => {
        if (e.candidate) {
          if (directorId) socket.emit("signal", { to: directorId, data: e.candidate });
        }
      };
    }

    socket.on("signal", ({ from, data }) => {
      if (data.type === "offer") {
        directorId = from;
        pc.setRemoteDescription(new RTCSessionDescription(data));
        pc.createAnswer().then(ans => {
          pc.setLocalDescription(ans);
          socket.emit("signal", { to: from, data: ans });
        });
      } else if (data.candidate) {
        pc.addIceCandidate(new RTCIceCandidate(data)).catch(console.warn);
      }
    });

  </script>
</body>