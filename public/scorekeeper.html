<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Basketball Scorekeeper – CourtStream</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='2'><circle cx='12' cy='12' r='10'/><path d='M9.5 8l6 4-6 4V8z' fill='white' stroke='none'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg: #0f1115;
            --panel: #161922;
            --border: #262b3d;
            --text: #e6e6eb;
            --muted: #9aa0b4;
            --blue: #3b82f6;
            --red: #ef4444;
            --green: #22c55e;
            --amber: #f59e0b;
            --teamA: var(--red);
            --teamB: var(--blue);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, sans-serif;
            overflow: hidden;
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior-y: none;
        }

        /* FULL SCREEN APP CONTAINER */
        .app-container {
            display: flex;
            flex-direction: column;
            height: var(--app-height, 100vh);
            width: 100vw;
            max-width: 450px;
            /* Max width for testing on desktop, fills mobile */
            margin: 0 auto;
            background: var(--bg);
            position: relative;
        }

        /* HEADER / BACK NAVIGATION */
        .header {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        /* SCOREBOARD (TOP SECTION) */
        .scoreboard {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .team-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 45%;
        }

        .team-name {
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 4px;
            color: var(--muted);
            cursor: pointer;
            /* Can edit name later */
        }

        .team-score {
            font-size: 56px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .teamA-score {
            color: var(--teamA);
        }

        .teamB-score {
            color: var(--teamB);
        }

        .timeout-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .timeout-btn.used {
            opacity: 0.5;
            text-decoration: line-through;
        }

        /* PERIOD / MATCH CONTROLS */
        .match-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            background: #000;
            flex-shrink: 0;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
            gap: 16px;
        }

        /* ROSTERS (MIDDLE SECTION) */
        .rosters-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .roster {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            /* specific styling for smooth scroll on iOS */
            -webkit-overflow-scrolling: touch;
        }

        .roster::-webkit-scrollbar {
            width: 4px;
        }

        .roster::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .player-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--panel);
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.2s;
            user-select: none;
        }

        .player-row:active {
            transform: scale(0.97);
        }

        .player-row.teamA:active {
            border-color: var(--teamA);
        }

        .player-row.teamB:active {
            border-color: var(--teamB);
        }

        .jersey {
            font-size: 20px;
            font-weight: 800;
        }

        .fouls {
            font-size: 12px;
            color: var(--red);
            font-weight: 600;
            display: flex;
            gap: 2px;
        }

        .foul-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--border);
        }

        .foul-dot.active {
            background: var(--red);
        }

        /* BOTTOM ACTIONS */
        .bottom-bar {
            padding: 16px;
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            /* PB for mobile home indicator */
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }

        .action-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 800;
            color: white;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-livesheet {
            background: var(--border);
        }

        .btn-endgame {
            background: var(--red);
        }

        /* ACTION POPUP (MODAL) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            /* Pop up from bottom */
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .action-sheet {
            background: var(--panel);
            width: 100%;
            max-width: 450px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* Add bottom padding for iOS home indicator */
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
        }

        .modal-overlay.active .action-sheet {
            transform: translateY(0);
        }

        .sheet-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .sheet-title {
            font-size: 20px;
            font-weight: 800;
            margin: 0 0 4px;
        }

        .sheet-subtitle {
            color: var(--muted);
            font-size: 14px;
            margin: 0;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .score-btn {
            background: var(--border);
            border: 2px solid transparent;
            color: white;
            padding: 20px;
            border-radius: 16px;
            font-size: 24px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .score-btn small {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
        }

        .score-btn.pt1:active {
            border-color: var(--green);
            background: rgba(34, 197, 94, 0.1);
        }

        .score-btn.pt2:active {
            border-color: var(--blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .score-btn.pt3:active {
            border-color: var(--amber);
            background: rgba(245, 158, 11, 0.1);
        }

        .score-btn.foul {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
            border: 2px solid rgba(239, 68, 68, 0.2);
        }

        .score-btn.foul:active {
            border-color: var(--red);
            background: rgba(239, 68, 68, 0.3);
        }

        .cancel-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* LIVE SHEET MODAL (FULL SCREEN) */
        .livesheet-modal {
            position: fixed;
            inset: 0;
            background: #f8fafc;
            /* light paper background */
            z-index: 2000;
            display: none;
            flex-direction: column;
            color: #0f172a;
        }

        .livesheet-header {
            background: #1e293b;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: max(16px, env(safe-area-inset-top));
        }

        .livesheet-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .sheet-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: repeating-linear-gradient(#f8fafc, #f8fafc 39px, #e2e8f0 40px);
            font-family: 'Courier New', Courier, monospace;
        }

        .running-score {
            display: grid;
            grid-template-columns: 1fr 60px 1fr;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .rs-col {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Handwritten effect for score inputs */
        .ink {
            font-family: 'Caveat', cursive;
            font-size: 22px;
            color: #1d4ed8;
            /* Blue pen ink */
            transform: rotate(-2deg);
            line-height: 1;
        }

        .ink.red {
            color: #b91c1c;
        }

        /* END GAME SIGNATURE MODAL */
        .signature-modal {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 3000;
            display: none;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
        }

        .sig-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 24px;
        }

        .sig-box {
            margin-bottom: 24px;
        }

        .sig-box label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--muted);
        }

        canvas.sig-pad {
            width: 100%;
            height: 120px;
            background: white;
            border-radius: 12px;
            touch-action: none;
            /* Crucial for drawing */
        }

        /* FIBA SCORESHEET LAYOUT */
        .fiba-sheet {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            color: #000;
            font-family: Arial, sans-serif;
            font-size: 10px;
            line-height: 1.2;
        }

        .fiba-sheet input {
            border: none;
            border-bottom: 1px dotted #ccc;
            font-family: 'Caveat', cursive;
            font-size: 16px;
            color: #1d4ed8;
            background: transparent;
            outline: none;
            width: 100%;
        }

        .fiba-header-section {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }

        .fiba-logo-box {
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 24px;
            color: #22c55e;
            border: 2px solid #22c55e;
            margin-right: 10px;
        }

        .fiba-title-box {
            flex: 1;
            text-align: center;
            text-transform: uppercase;
        }

        .fiba-title-box h1 {
            font-size: 16px;
            margin: 0;
            font-weight: bold;
        }

        .fiba-title-box h2 {
            font-size: 18px;
            margin: 4px 0 0;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .fiba-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 30px;
            margin-bottom: 10px;
            border: 2px solid #000;
            padding: 10px;
        }

        .fiba-info-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            white-space: nowrap;
        }

        .fiba-info-row strong {
            font-size: 12px;
        }

        .fiba-info-row span {
            flex: 1;
            border-bottom: 1px solid #000;
            font-family: 'Caveat', cursive;
            font-size: 16px;
            color: #1d4ed8;
            padding-left: 5px;
        }

        .fiba-body-section {
            display: flex;
            border: 2px solid #000;
            border-bottom: none;
        }

        .fiba-left {
            width: 55%;
            border-right: 2px solid #000;
            display: flex;
            flex-direction: column;
        }

        .fiba-right {
            width: 45%;
            display: flex;
            flex-direction: column;
        }

        /* Running Score Header */
        .fiba-rs-header {
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            padding: 4px;
            border-bottom: 2px solid #000;
            letter-spacing: 1px;
        }

        /* 4 Column Running Score Grid */
        .fiba-rs-grid {
            display: flex;
            flex: 1;
        }

        .fiba-rs-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #000;
        }

        .fiba-rs-col:last-child {
            border-right: none;
        }

        .fiba-rs-col-header {
            display: flex;
            border-bottom: 2px solid #000;
            font-weight: bold;
        }

        .fiba-rs-col-header div {
            flex: 1;
            text-align: center;
            padding: 2px;
            border-right: 1px solid #000;
        }

        .fiba-rs-col-header div:last-child {
            border-right: none;
        }

        .fiba-rs-row {
            display: flex;
            border-bottom: 1px solid #ccc;
            height: 18px;
            /* Tightly packed */
        }

        .fiba-rs-cell {
            flex: 1;
            text-align: center;
            border-right: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            position: relative;
        }

        .fiba-rs-cell:last-child {
            border-right: none;
        }

        .fiba-rs-cell.num {
            font-weight: bold;
            background: #fdfdfd;
            border-right: 1px solid #000;
            border-left: 1px solid #000;
            width: 25px;
            flex: none;
        }

        .ink-slash {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #1d4ed8;
            transform: rotate(-30deg);
            z-index: 10;
        }

        .ink-slash.red {
            background: #b91c1c;
        }

        .ink-player {
            font-family: 'Caveat', cursive;
            font-size: 14px;
            color: #1d4ed8;
            font-weight: bold;
        }

        .ink-player.red {
            color: #b91c1c;
        }

        .ink-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #1d4ed8;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .ink-dot.red {
            background: #b91c1c;
        }

        .circled-ink {
            display: inline-block;
            border: 1px solid #1d4ed8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 18px;
            text-align: center;
        }

        .red .circled-ink {
            border-color: #b91c1c;
        }

        .period-end {
            border-bottom: 3px solid #000 !important;
        }

        .period-end-circle {
            border: 2px solid #000;
            border-radius: 50%;
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 14px;
        }

        /* Roster Tables */
        .fiba-team-box {
            border-bottom: 2px solid #000;
            display: flex;
            flex-direction: column;
        }

        .fiba-team-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 8px;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #000;
        }

        .fiba-timeouts-fouls {
            display: flex;
            border-bottom: 2px solid #000;
        }

        .fiba-timeouts {
            width: 140px;
            padding: 4px;
            border-right: 2px solid #000;
        }

        .fiba-timeouts-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        .fiba-box-group {
            display: flex;
            gap: 2px;
        }

        .fiba-box {
            width: 16px;
            height: 16px;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Caveat', cursive;
            font-size: 16px;
            color: #1d4ed8;
            font-weight: bold;
        }

        .fiba-team-fouls {
            flex: 1;
            padding: 4px;
        }

        .fiba-roster-table {
            width: 100%;
            border-collapse: collapse;
        }

        .fiba-roster-table th,
        .fiba-roster-table td {
            border: 1px solid #000;
            padding: 2px 4px;
            text-align: center;
            height: 24px;
        }

        .fiba-roster-table th {
            font-weight: bold;
            background: #f0f0f0;
        }

        .fiba-roster-table td.left {
            text-align: left;
        }

        .fiba-coach-row {
            display: flex;
            border-bottom: 1px solid #000;
        }

        .fiba-coach-row:last-child {
            border-bottom: none;
        }

        .fiba-coach-label {
            padding: 4px;
            width: 100px;
            border-right: 1px solid #000;
        }

        .fiba-coach-input {
            flex: 1;
            padding: 4px;
        }

        /* Signatures Section at bottom */
        .fiba-footer-section {
            border: 2px solid #000;
            display: flex;
        }

        .fiba-signatures {
            flex: 1;
            border-right: 2px solid #000;
            padding: 8px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .fiba-sig-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .fiba-sig-row label {
            width: 140px;
            font-weight: bold;
        }

        .fiba-sig-line {
            flex: 1;
            border-bottom: 1px solid #000;
            min-height: 16px;
        }

        .fiba-final-score {
            width: 250px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-weight: bold;
            font-size: 14px;
        }

        .fiba-final-score-row {
            display: flex;
            justify-content: space-between;
        }

        /* FULL SCREEN SIGNATURE MODAL */
        .sig-capture-modal {
            position: fixed;
            inset: 0;
            background: var(--panel);
            z-index: 5000;
            display: none;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
        }

        .sig-capture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #1e293b;
            color: white;
            font-weight: 800;
        }

        .sig-capture-body {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .sig-capture-canvas-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
            touch-action: none;
        }

        #activeSigPad {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        .sig-capture-footer {
            display: flex;
            gap: 16px;
            padding-top: 24px;
            padding-bottom: env(safe-area-inset-bottom, 24px);
        }

        .sig-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 800;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-clear {
            background: var(--border);
        }

        .btn-save-sig {
            background: var(--blue);
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .livesheet-modal,
            .livesheet-modal * {
                visibility: visible;
            }

            .livesheet-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                display: flex !important;
            }

            .livesheet-header {
                display: none !important;
            }

            .sheet-body {
                background: white !important;
                padding: 0;
            }

            .fiba-sheet {
                max-width: 100%;
                transform: scale(0.95);
                transform-origin: top left;
            }

            /* Make exact A4 print sizing */
            @page {
                size: A4 portrait;
                margin: 8mm;
            }
        }

        /* --- SETUP PHASE --- */
        .setup-container {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 9000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 40px;
        }

        .setup-body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .setup-card {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .setup-card h3 {
            margin: 0 0 16px 0;
            color: var(--text);
            font-size: 16px;
            font-weight: 800;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .setup-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .setup-radio-group {
            display: flex;
            gap: 16px;
        }

        .setup-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .setup-roster-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .setup-btn {
            background: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
        }

        .setup-btn-start {
            background: #10b981;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            margin-top: 16px;
            cursor: pointer;
        }

        .draft-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .draft-table th,
        .draft-table td {
            text-align: left;
            padding: 6px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .draft-table th {
            color: var(--muted);
            font-weight: 600;
        }

        .remove-draft-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- FULL SCREEN LOADER -->
    <div id="liveSheetLoader"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; flex-direction:column; justify-content:center; align-items:center; color:white;">
        <div
            style="width:50px; height:50px; border:4px solid rgba(255,255,255,0.2); border-top-color:#3b82f6; border-radius:50%; animation:loader-spin 1s linear infinite;">
        </div>
        <div style="margin-top:20px; font-weight:600; font-size:18px; letter-spacing:1px;">GENERATING SCORESHEET...
        </div>
        <div style="margin-top:8px; font-size:14px; margin-bottom: 24px; color:#94a3b8;">Processing Chronological
            Layouts</div>
        <style>
            @keyframes loader-spin {
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </div>
    <script>
        // Set dynamic app height for mobile browsers
        function setAppHeight() {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', setAppHeight);
        window.addEventListener('orientationchange', () => setTimeout(setAppHeight, 100));
        setAppHeight();
    </script>

    <!-- SETUP PHASE -->
    <div class="setup-container" id="setupPhase">
        <div class="header">
            <button class="back-btn" onclick="location.href='index.html'">←</button>
            <div
                style="flex:1; text-align:center; font-weight:800; font-size:14px; letter-spacing:1px; color:var(--muted)">
                SETUP GAME</div>
            <div style="width:24px"></div>
        </div>

        <div class="setup-body">
            <!-- Format Choice -->
            <div class="setup-card">
                <h3>Scoresheet Format</h3>
                <div class="setup-radio-group">
                    <label class="setup-radio"><input type="radio" name="sheetFormat" value="FIBA" checked> FIBA
                        Standard</label>
                    <label class="setup-radio"><input type="radio" name="sheetFormat" value="JDBA"> JDBA
                        Standard</label>
                </div>
            </div>

            <!-- Match Details -->
            <div class="setup-card">
                <h3>Match Details</h3>
                <div class="setup-grid">
                    <input type="text" id="setupComp" class="setup-input" placeholder="Competition">
                    <input type="date" id="setupDate" class="setup-input">
                    <input type="time" id="setupTime" class="setup-input">
                    <input type="text" id="setupGameNo" class="setup-input" placeholder="Game No.">
                    <input type="text" id="setupPlace" class="setup-input" placeholder="Place / Court"
                        style="grid-column: span 2;">
                    <input type="text" id="setupRef" class="setup-input" placeholder="Referee"
                        style="grid-column: span 2;">
                    <input type="text" id="setupUmp1" class="setup-input" placeholder="Umpire 1"
                        style="grid-column: span 2;">
                    <input type="text" id="setupUmp2" class="setup-input" placeholder="Umpire 2"
                        style="grid-column: span 2;">
                </div>
            </div>

            <!-- Team Details -->
            <div class="setup-card">
                <h3>Teams</h3>
                <div style="display:flex; gap:16px;">
                    <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                        <input type="text" id="setupTeamA" class="setup-input" placeholder="Team A Name" value="TEAM A">
                        <input type="text" id="setupCoachA" class="setup-input" placeholder="Team A Coach">
                        <input type="text" id="setupAsstA" class="setup-input" placeholder="Team A Asst. Coach">
                    </div>
                    <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                        <input type="text" id="setupTeamB" class="setup-input" placeholder="Team B Name" value="TEAM B">
                        <input type="text" id="setupCoachB" class="setup-input" placeholder="Team B Coach">
                        <input type="text" id="setupAsstB" class="setup-input" placeholder="Team B Asst. Coach">
                    </div>
                </div>
            </div>

            <!-- Roster Builder -->
            <div class="setup-card">
                <h3>Build Rosters</h3>
                <div class="setup-roster-form">
                    <select id="draftTeamSelect" class="setup-input" style="flex:1;">
                        <option value="A">Team A</option>
                        <option value="B">Team B</option>
                    </select>
                    <input type="number" id="draftNumber" class="setup-input" placeholder="No." style="width:60px;">
                    <input type="text" id="draftName" class="setup-input" placeholder="Player Name" style="flex:2;">
                    <button class="setup-btn" onclick="addDraftPlayer()"
                        style="padding: 12px; font-size: 14px;">Add</button>
                </div>

                <div style="display:flex; gap:16px; margin-top:16px;">
                    <div style="flex:1;">
                        <h4 style="margin:0 0 8px 0; color:var(--text); font-size:12px;">Team A Roster</h4>
                        <table class="draft-table" id="draftTableA">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="flex:1;">
                        <h4 style="margin:0 0 8px 0; color:var(--text); font-size:12px;">Team B Roster</h4>
                        <table class="draft-table" id="draftTableB">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <button class="setup-btn-start" onclick="startMatch()">START MATCH</button>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="app-container" id="mainApp" style="display:none;">

        <!-- HEADER -->
        <div class="header">
            <button class="back-btn" onclick="location.href='index.html'">←</button>
            <div
                style="flex:1; text-align:center; font-weight:800; font-size:14px; letter-spacing:1px; color:var(--muted)">
                LIVE SCOREKEEPER</div>
            <div style="width:24px"></div> <!-- Spacer -->
        </div>

        <!-- SCOREBOARD -->
        <div class="scoreboard">
            <div class="team-box">
                <div class="team-name" onclick="renameTeam('A')" id="nameA">TEAM A</div>
                <div class="team-score teamA-score" id="scoreA">0</div>
                <button class="timeout-btn" onclick="takeTimeout('A')">Timeout <span id="toA">3</span></button>
            </div>
            <div class="team-box">
                <div class="team-name" onclick="renameTeam('B')" id="nameB">TEAM B</div>
                <div class="team-score teamB-score" id="scoreB">0</div>
                <button class="timeout-btn" onclick="takeTimeout('B')">Timeout <span id="toB">3</span></button>
            </div>
        </div>

        <div class="match-controls">
            <button onclick="changePeriod(-1)"
                style="padding:4px 8px; border-radius:4px; border:none; background:var(--border); color:white;">-</button>
            <span id="periodLbl">Period 1</span>
            <button onclick="changePeriod(1)"
                style="padding:4px 8px; border-radius:4px; border:none; background:var(--border); color:white;">+</button>
        </div>

        <!-- ROSTERS -->
        <div class="rosters-container">
            <div class="roster" id="rosterA">
                <!-- Team A Players injected here -->
            </div>
            <div style="width:1px; background:var(--border); margin: 8px 0;"></div>
            <div class="roster" id="rosterB">
                <!-- Team B Players injected here -->
            </div>
        </div>

        <!-- BOTTOM BAR -->
        <div class="bottom-bar">
            <button class="action-btn btn-livesheet" onclick="openLiveSheet()">View Live Sheet</button>
            <button class="action-btn btn-endgame" onclick="openEndGame()">End Game</button>
        </div>

    </div>

    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="actionModal" onclick="closeActionModal(event)">
        <div class="action-sheet" onclick="event.stopPropagation()">
            <div class="sheet-header">
                <div class="sheet-title" id="actionTitle">Player Name</div>
                <div class="sheet-subtitle" id="actionSubtitle">Team A • #4</div>
            </div>
            <div class="action-grid">
                <button class="score-btn pt1" onclick="addScore(1)">
                    +1 <small>Free Throw</small>
                </button>
                <button class="score-btn pt2" onclick="addScore(2)">
                    +2 <small>Field Goal</small>
                </button>
                <button class="score-btn pt3" onclick="addScore(3)" style="grid-column: span 2;">
                    +3 <small>3-Pointer</small>
                </button>
                <div class="action-grid"
                    style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                    <div
                        style="grid-column: span 2; font-size:12px; font-weight:800; color:var(--muted); text-align:center;">
                        FOULS</div>
                    <button class="score-btn foul" onclick="addFoul('P')" style="font-size:14px; padding:12px;">P
                        <small>Personal</small></button>
                    <button class="score-btn foul" onclick="addFoul('P1')" style="font-size:14px; padding:12px;">P₁
                        <small>1 FT</small></button>
                    <button class="score-btn foul" onclick="addFoul('P2')" style="font-size:14px; padding:12px;">P₂
                        <small>2 FT</small></button>
                    <button class="score-btn foul" onclick="addFoul('P3')" style="font-size:14px; padding:12px;">P₃
                        <small>3 FT</small></button>
                    <button class="score-btn foul" onclick="addFoul('T')"
                        style="font-size:14px; padding:12px; background:#f97316;">T <small>Technical</small></button>
                    <button class="score-btn foul" onclick="addFoul('U')"
                        style="font-size:14px; padding:12px; background:#eab308;">U <small>Unsportsm.</small></button>
                    <button class="score-btn foul" onclick="addFoul('D')"
                        style="font-size:14px; padding:12px; background:#000; grid-column: span 2;">D
                        <small>Disqualifying</small></button>
                </div>
                <button class="cancel-btn" onclick="closeActionModal()" style="margin-top:16px;">Cancel</button>
            </div>
        </div>
    </div> <!-- END ACTION MODAL -->

    <!-- FIBA SCORESHEET MODAL (PRINTABLE) -->
    <div class="livesheet-modal" id="liveSheetModal">
        <div class="livesheet-header" id="lsHeaderControls">
            <div style="font-weight:800; font-size:14px;">OFFICIAL FIBA SCORESHEET</div>
            <div style="display:flex; gap:16px; align-items:center;">
                <button onclick="window.print()"
                    style="background:var(--blue); color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:600; cursor:pointer;">Print</button>
                <button class="livesheet-close" onclick="closeLiveSheet()">✕</button>
            </div>
        </div>

        <div class="sheet-body">
            <div class="fiba-sheet" id="fibaSheet">
                <!-- Header Section -->
                <div class="fiba-header-section">
                    <div class="fiba-logo-box">FIBA</div>
                    <div class="fiba-title-box" id="fibaTitleObj">
                        <h1>Federation Internationale de Basketball</h1>
                        <h1>International Basketball Federation</h1>
                        <h2>SCORESHEET</h2>
                    </div>
                </div>

                <div class="fiba-info-grid">
                    <div class="fiba-info-row"><strong>Team A</strong> <span id="fibaTeamA_Name">TEAM A</span></div>
                    <div class="fiba-info-row"><strong>Team B</strong> <span id="fibaTeamB_Name">TEAM B</span></div>
                    <div class="fiba-info-row"><strong>Competition</strong> <span class="ink"
                            id="fibaCompetition"></span></div>
                    <div class="fiba-info-row"><strong>Referee</strong> <span class="ink" id="fibaReferee"></span>
                    </div>
                    <div class="fiba-info-row"><strong>Date</strong> <span class="ink" id="fibaDate"></span></div>
                    <div class="fiba-info-row"><strong>Umpire 1</strong> <span class="ink" id="fibaUmpire1"></span>
                    </div>
                    <div class="fiba-info-row"><strong>Time</strong> <span class="ink" id="fibaTime"></span></div>
                    <div class="fiba-info-row"><strong>Umpire 2</strong> <span class="ink" id="fibaUmpire2"></span>
                    </div>
                </div>

                <!-- Main Body -->
                <div class="fiba-body-section">
                    <!-- Left Column -->
                    <div class="fiba-left">
                        <!-- Team A Roster Block -->
                        <div class="fiba-team-box" id="fibaRosterA_Box"></div>
                        <!-- Team B Roster Block -->
                        <div class="fiba-team-box" id="fibaRosterB_Box"></div>
                    </div>

                    <!-- Right Column (Running Score) -->
                    <div class="fiba-right">
                        <div class="fiba-rs-header">RUNNING SCORE</div>
                        <div class="fiba-rs-grid" id="fibaRunningScoreGrid"></div>
                    </div>
                </div>

                <!-- Footer Signatures -->
                <div class="fiba-footer-section">
                    <div class="fiba-signatures">
                        <div class="fiba-sig-row"><label>Scorekeeper</label>
                            <div class="fiba-sig-line" onclick="openSignatureCapture('sig_scorer', 'Scorekeeper')">
                                <canvas class="sig-pad" id="sig_scorer"
                                    style="height:30px; pointer-events:none;"></canvas>
                            </div>
                        </div>
                        <div class="fiba-sig-row"><label>Timekeeper</label>
                            <div class="fiba-sig-line" onclick="openSignatureCapture('sig_timekeeper', 'Timekeeper')">
                                <canvas class="sig-pad" id="sig_timekeeper"
                                    style="height:30px; pointer-events:none;"></canvas>
                            </div>
                        </div>
                        <div class="fiba-sig-row"><label>24" operator</label>
                            <div class="fiba-sig-line" onclick="openSignatureCapture('sig_24op', '24\u0022 Operator')">
                                <canvas class="sig-pad" id="sig_24op"
                                    style="height:30px; pointer-events:none;"></canvas>
                            </div>
                        </div>
                        <div class="fiba-sig-row"><label>Referee</label>
                            <div class="fiba-sig-line" onclick="openSignatureCapture('sig_ref', 'Referee')"><canvas
                                    class="sig-pad" id="sig_ref" style="height:30px; pointer-events:none;"></canvas>
                            </div>
                        </div>
                        <div class="fiba-sig-row"><label>Umpire 1</label>
                            <div class="fiba-sig-line" onclick="openSignatureCapture('sig_ump1', 'Umpire 1')">
                                <canvas class="sig-pad" id="sig_ump1"
                                    style="height:30px; pointer-events:none;"></canvas>
                            </div>
                        </div>
                        <div class="fiba-sig-row"><label>Umpire 2</label>
                            <div class="fiba-sig-line" onclick="openSignatureCapture('sig_ump2', 'Umpire 2')">
                                <canvas class="sig-pad" id="sig_ump2"
                                    style="height:30px; pointer-events:none;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="fiba-final-score">
                        <div class="fiba-final-score-row"><span>Final Score:</span> <span>Team A <span id="fibaFinalA"
                                    class="ink red"></span></span></div>
                        <div class="fiba-final-score-row"><span></span> <span>Team B <span id="fibaFinalB"
                                    class="ink"></span></span></div>
                        <div style="margin-top:auto; border-top:1px solid #000; padding-top:4px;">
                            Name of winning team:<br><span id="fibaWinner" class="ink" style="font-size:24px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <p style="text-align:center; color:#64748b; font-size:12px; margin-top:40px;">End of live preview.</p>
        </div>
    </div>

    <!-- SIGNATURE CAPTURE MODAL -->
    <div class="sig-capture-modal" id="sigCaptureModal">
        <div class="sig-capture-header">
            <div id="sigRoleTitle">Sign Here</div>
            <button onclick="closeSignatureCapture()"
                style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">✕</button>
        </div>
        <div class="sig-capture-body">
            <h3 style="color:var(--text); text-align:center; margin-top:0;">Please provide your signature:</h3>
            <div class="sig-capture-canvas-container">
                <canvas id="activeSigPad"></canvas>
            </div>
            <div class="sig-capture-footer">
                <button class="sig-btn btn-clear" onclick="clearSignature()">Clear</button>
                <button class="sig-btn btn-save-sig" onclick="saveSignature()">Save Signature</button>
            </div>
        </div>
    </div>

    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            fetch("http://localhost:8081/log_error?msg=" + encodeURIComponent(msg + " at " + lineNo));
            return false;
        };

        // --- STATE ---
        let state = {
            period: 1,
            teamA: { name: "TEAM A", score: 0, timeouts: 3, roster: [] },
            teamB: { name: "TEAM B", score: 0, timeouts: 3, roster: [] },
            events: [] // { time, type: 'score'|'foul', team: 'A'|'B', player: #, pts: 1|2|3 }
        };

        let selectedPlayer = null; // { team: 'A', number: 4 }

        // --- INIT ---
        function initRosters() {
            // Generate default FIBA numbers 4-15
            for (let i = 4; i <= 15; i++) {
                state.teamA.roster.push({ number: i, fouls: 0, pts: 0 });
                state.teamB.roster.push({ number: i, fouls: 0, pts: 0 });
            }
            renderRosters();
        }

        function renderRosters() {
            const rA = document.getElementById("rosterA");
            const rB = document.getElementById("rosterB");
            rA.innerHTML = ''; rB.innerHTML = '';

            let winningTeam = null;
            let maxPts = 0;
            if (state.teamA.score > state.teamB.score) {
                winningTeam = 'A';
                maxPts = Math.max(...state.teamA.roster.map(p => p.pts));
            } else if (state.teamB.score > state.teamA.score) {
                winningTeam = 'B';
                maxPts = Math.max(...state.teamB.roster.map(p => p.pts));
            }

            state.teamA.roster.forEach(p => rA.appendChild(createPlayerRow('A', p, winningTeam === 'A' && maxPts > 0 && p.pts === maxPts)));
            state.teamB.roster.forEach(p => rB.appendChild(createPlayerRow('B', p, winningTeam === 'B' && maxPts > 0 && p.pts === maxPts)));
        }

        function createPlayerRow(team, player, isMotm = false) {
            const div = document.createElement("div");
            div.className = `player-row team${team}`;
            div.onclick = () => openActionModal(team, player);

            let foulHtml = '';
            for (let i = 0; i < 5; i++) {
                foulHtml += `<div class="foul-dot ${i < player.fouls ? 'active' : ''}"></div>`;
            }

            const jerseyDiv = document.createElement("div");
            jerseyDiv.className = "jersey";
            jerseyDiv.innerText = `#${player.number}`;
            jerseyDiv.onclick = (e) => {
                e.stopPropagation();
                const newNum = prompt(`Enter new jersey number for Player #${player.number}`, player.number);
                if (newNum && newNum.trim() !== '') {
                    player.number = newNum.trim();
                    renderRosters();
                }
            };

            div.appendChild(jerseyDiv);

            const statsDiv = document.createElement("div");
            statsDiv.style.textAlign = "right";

            let motmHtml = isMotm ? `<span style="background:var(--amber); color:#0f172a; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:800; margin-right:6px; letter-spacing:0.5px; vertical-align:middle; display:inline-block;">MOTM 🏆</span>` : '';

            statsDiv.innerHTML = `
              <div style="font-size:12px; font-weight:600; color:var(--muted); margin-bottom:4px;">${motmHtml}${player.pts} pts</div>
              <div class="fouls">${foulHtml}</div>
            `;
            div.appendChild(statsDiv);

            return div;
        }

        // --- ACTIONS ---
        function openActionModal(team, player) {
            if (player.fouls >= 5) {
                alert("Player fouled out.");
                return;
            }

            // Haptic Feedback
            if (navigator.vibrate) navigator.vibrate(50);

            selectedPlayer = { team, player };

            const teamName = team === 'A' ? state.teamA.name : state.teamB.name;
            document.getElementById("actionTitle").innerText = `Player #${player.number}`;
            document.getElementById("actionSubtitle").innerText = `${teamName} • ${player.pts} pts / ${player.fouls} fouls`;

            document.getElementById("actionModal").classList.add("active");
        }

        function closeActionModal(e) {
            if (e && e.target !== document.getElementById("actionModal")) return;
            document.getElementById("actionModal").classList.remove("active");
            selectedPlayer = null;
        }

        function addScore(pts) {
            if (!selectedPlayer) return;
            // Haptics for score
            if (navigator.vibrate) navigator.vibrate([30, 50, 30]);

            const t = selectedPlayer.team;
            const pId = selectedPlayer.player.number;

            // Update State
            state[`team${t}`].score += pts;
            selectedPlayer.player.pts += pts;

            state.events.push({
                time: Date.now(), period: state.period, type: 'score', team: t, player: pId, pts: pts, totalA: state.teamA.score, totalB: state.teamB.score
            });

            // Update UI
            document.getElementById(`score${t}`).innerText = state[`team${t}`].score;
            renderRosters();
            closeActionModal();
        }

        function addFoul(foulType = 'P') {
            if (!selectedPlayer) return;
            // Heavy haptics for foul
            if (navigator.vibrate) navigator.vibrate(100);

            const t = selectedPlayer.team;
            const pId = selectedPlayer.player.number;

            selectedPlayer.player.fouls += 1;

            state.events.push({
                time: Date.now(), period: state.period, type: 'foul', team: t, player: pId, foulType: foulType
            });

            renderRosters();
            closeActionModal();
        }

        function takeTimeout(team) {
            if (state[`team${team}`].timeouts > 0) {
                const minute = prompt(`Enter the minute of the period for this Time-out (e.g. 5):`);
                if (!minute) return; // Cancelled

                state[`team${team}`].timeouts--;
                document.getElementById(`to${team}`).innerText = state[`team${team}`].timeouts;
                if (state[`team${team}`].timeouts === 0) {
                    document.querySelector(`#name${team}`).closest('.team-box').querySelector('.timeout-btn').classList.add('used');
                }

                state.events.push({
                    time: Date.now(), period: state.period, type: 'timeout', team: team, minute: minute
                });
            }
        }

        function changePeriod(delta) {
            state.period = Math.max(1, Math.min(4, state.period + delta));
            document.getElementById("periodLbl").innerText = `Period ${state.period}`;
        }

        function renameTeam(team) {
            const newName = prompt(`Enter new name for Team ${team}`, state[`team${team}`].name);
            if (newName) {
                state[`team${team}`].name = newName.substring(0, 12).toUpperCase();
                document.getElementById(`name${team}`).innerText = state[`team${team}`].name;
            }
        }

        // --- LIVE SHEET PREVIEW ---
        function openLiveSheet() {
            // Show loader immediately
            document.getElementById('liveSheetLoader').style.display = 'flex';

            setTimeout(() => {
                try {
                    const modal = document.getElementById("liveSheetModal");

                    // Set Title Based on Format
                    const titleObj = document.getElementById("fibaTitleObj");
                    if (titleObj) {
                        if (state.meta && state.meta.format === 'JDBA') {
                            titleObj.innerHTML = `<h1 style="font-size:24px; margin:0 0 8px 0; text-transform:uppercase;">Japan Basketball Association</h1><h2 style="font-size:18px; margin:0; letter-spacing:4px;">SCORESHEET</h2>`;
                        } else {
                            titleObj.innerHTML = `<h1 style="font-size:16px; margin:0;">Federation Internationale de Basketball</h1><h1 style="font-size:16px; margin:0 0 8px 0;">International Basketball Federation</h1><h2 style="font-size:24px; margin:0; letter-spacing:4px;">SCORESHEET</h2>`;
                        }
                    }

                    // Set Header Info
                    const meta = state.meta || {};
                    document.getElementById("fibaCompetition").innerText = meta.competition || "";
                    document.getElementById("fibaDate").innerText = meta.date || "";
                    document.getElementById("fibaTime").innerText = meta.time || "";
                    document.getElementById("fibaReferee").innerText = meta.referee || "";
                    document.getElementById("fibaUmpire1").innerText = meta.umpire1 || "";
                    document.getElementById("fibaUmpire2").innerText = meta.umpire2 || "";

                    document.getElementById("fibaTeamA_Name").innerText = state.teamA.name;
                    document.getElementById("fibaTeamB_Name").innerText = state.teamB.name;
                    document.getElementById("fibaFinalA").innerText = state.teamA.score;
                    document.getElementById("fibaFinalB").innerText = state.teamB.score;

                    const winner = state.teamA.score > state.teamB.score ? state.teamA.name :
                        (state.teamB.score > state.teamA.score ? state.teamB.name : 'TIE');
                    document.getElementById("fibaWinner").innerText = winner;

                    // Generate Running Score
                    generateRunningScore();

                    // Generate Rosters
                    generateFibaRoster('A');
                    generateFibaRoster('B');

                    modal.style.display = "flex";

                    if (!inlineCanvasesSetup) {
                        setTimeout(setupInlineCanvases, 50); // Small delay to let DOM render
                        inlineCanvasesSetup = true;
                    }

                } catch (e) {
                    alert("LIVE SHEET CRASH: " + e.message + "\n\n" + e.stack);
                } finally {
                    document.getElementById('liveSheetLoader').style.display = 'none';
                }
            }, 50);
        }

        function generateRunningScore() {
            let rsData = { A: Array(161).fill(null), B: Array(161).fill(null) };
            let runningScoreA = 0;
            let runningScoreB = 0;

            // Track chronological events
            state.events.forEach(e => {
                if (e.type === 'score') {
                    const team = e.team;
                    const pts = e.pts;
                    const oldScore = team === 'A' ? runningScoreA : runningScoreB;
                    const newScore = oldScore + pts;

                    if (team === 'A') runningScoreA = newScore;
                    else runningScoreB = newScore;

                    // Only draw if within bounds
                    if (pts === 1) {
                        if (newScore <= 160) rsData[team][newScore] = { symbol: 'dot', player: e.player, circled: false };
                    } else if (pts === 2) {
                        if (newScore <= 160) rsData[team][newScore] = { symbol: 'slash', player: e.player, circled: false };
                        if (newScore - 1 <= 160 && newScore - 1 > 0) rsData[team][newScore - 1] = { symbol: 'slash', player: null, circled: false };
                    } else if (pts === 3) {
                        if (newScore <= 160) rsData[team][newScore] = { symbol: 'slash', player: e.player, circled: true };
                        if (newScore - 1 <= 160 && newScore - 1 > 0) rsData[team][newScore - 1] = { symbol: 'slash', player: null, circled: false };
                        if (newScore - 2 <= 160 && newScore - 2 > 0) rsData[team][newScore - 2] = { symbol: 'slash', player: null, circled: false };
                    }
                } else if (e.type === 'periodEnd') {
                    if (runningScoreA <= 160 && runningScoreA > 0) {
                        if (!rsData.A[runningScoreA]) rsData.A[runningScoreA] = {};
                        rsData.A[runningScoreA].periodEnd = true;
                    }
                    if (runningScoreB <= 160 && runningScoreB > 0) {
                        if (!rsData.B[runningScoreB]) rsData.B[runningScoreB] = {};
                        rsData.B[runningScoreB].periodEnd = true;
                    }
                }
            });

            const grid = document.getElementById("fibaRunningScoreGrid");
            grid.innerHTML = '';

            for (let block = 0; block < 4; block++) {
                const colDiv = document.createElement('div');
                colDiv.className = 'fiba-rs-col';
                colDiv.innerHTML = `<div class="fiba-rs-col-header"><div>A</div><div>B</div></div>`;

                for (let r = 1; r <= 40; r++) {
                    const scoreVal = block * 40 + r;

                    const aData = rsData.A[scoreVal];
                    const bData = rsData.B[scoreVal];

                    // Team A
                    let aPlayerHtml = '';
                    let aSymbolHtml = '';
                    let aContainerClass = 'fiba-rs-cell num';
                    let aScoreStr = scoreVal;

                    if (aData) {
                        if (aData.periodEnd) {
                            aContainerClass += ' period-end';
                            aScoreStr = `<div class="period-end-circle">${scoreVal}</div>`;
                        }
                        if (aData.player) {
                            let pNum = aData.circled ? `<span class="circled-ink">${aData.player}</span>` : aData.player;
                            aPlayerHtml = `<div class="ink-player red">${pNum}</div>`;
                        }
                        if (aData.symbol === 'slash') aSymbolHtml = `<div class="ink-slash red"></div>`;
                        if (aData.symbol === 'dot') aSymbolHtml = `<div class="ink-dot red"></div>`;
                    }

                    // Team B
                    let bPlayerHtml = '';
                    let bSymbolHtml = '';
                    let bContainerClass = 'fiba-rs-cell num';
                    let bScoreStr = scoreVal;

                    if (bData) {
                        if (bData.periodEnd) {
                            bContainerClass += ' period-end';
                            bScoreStr = `<div class="period-end-circle">${scoreVal}</div>`;
                        }
                        if (bData.player) {
                            let pNum = bData.circled ? `<span class="circled-ink">${bData.player}</span>` : bData.player;
                            bPlayerHtml = `<div class="ink-player">${pNum}</div>`;
                        }
                        if (bData.symbol === 'slash') bSymbolHtml = `<div class="ink-slash"></div>`;
                        if (bData.symbol === 'dot') bSymbolHtml = `<div class="ink-dot"></div>`;
                    }

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'fiba-rs-row';
                    rowDiv.innerHTML = `
                            <div class="fiba-rs-cell">${aPlayerHtml}</div>
                            <div class="${aContainerClass}">${aScoreStr}${aSymbolHtml}</div>
                            <div class="${bContainerClass}">${bScoreStr}${bSymbolHtml}</div>
                            <div class="fiba-rs-cell">${bPlayerHtml}</div>
                        `;
                    colDiv.appendChild(rowDiv);
                }
                grid.appendChild(colDiv);
            }
        }

        function generateFibaRoster(team) {
            const teamState = state[`team${team}`];
            const box = document.getElementById(`fibaRoster${team}_Box`);

            const timeoutsForTeam = state.events.filter(e => e.type === 'timeout' && e.team === team);
            let toBoxesHtml = '';
            for (let i = 0; i < 3; i++) {
                const to = timeoutsForTeam[i];
                toBoxesHtml += `<div class="fiba-box">${to ? `<span class="ink" style="color:#1d4ed8; font-weight:bold;">${to.minute}</span>` : ''}</div>`;
            }

            let html = `
                <div class="fiba-team-header">
                    <span>Team ${team}:</span>
                    <span style="font-family:'Caveat'; color:#1d4ed8; font-size:18px;">${teamState.name}</span>
                </div>
                <div class="fiba-timeouts-fouls">
                    <div class="fiba-timeouts">
                        <strong>Time-outs</strong>
                        <div class="fiba-timeouts-row">
                            <div class="fiba-box-group">
                                ${toBoxesHtml}
                            </div>
                        </div>
                    </div>
                    <div class="fiba-team-fouls">
                        <!-- Simplified FIBA team fouls layout omitted for brevity -->
                    </div>
                </div>
                <table class="fiba-roster-table">
                    <thead>
                        <tr>
                            <th style="width:20px">No.</th>
                            <th class="left">Players</th>
                            <th colspan="5">Fouls</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            teamState.roster.forEach(p => {
                const foulsForPlayer = state.events.filter(e => e.type === 'foul' && e.team === team && e.player === p.number);
                let foulBoxesHtml = '';
                for (let i = 0; i < 5; i++) {
                    const f = foulsForPlayer[i];
                    if (f) {
                        const styleClass = (f.foulType === 'T' || f.foulType === 'U' || f.foulType === 'D') ? 'ink red' : 'ink';
                        let fStr = f.foulType || 'P';
                        if (fStr.length === 2 && fStr.startsWith('P')) {
                            fStr = `P<sub>${fStr[1]}</sub>`;
                        }
                        foulBoxesHtml += `<td><span class="${styleClass}" style="color:${styleClass.includes('red') ? '#b91c1c' : '#1d4ed8'}; font-weight:bold; font-size:14px;">${fStr}</span></td>`;
                    } else {
                        foulBoxesHtml += `<td></td>`;
                    }
                }

                html += `<tr>
                    <td><strong>${p.number}</strong></td>
                    <td class="left"><input type="text" style="border:none; border-bottom:1px dotted #ccc; width:100%; font-family:Caveat; color:#1d4ed8; height:20px; font-size:14px;" placeholder="Player Name" value="${p.name}"></td>
                    ${foulBoxesHtml}
                </tr>`;
            });

            html += `
                    </tbody>
                </table>
                <div class="fiba-coach-row"><div class="fiba-coach-label">Coach</div><div class="fiba-coach-input" onclick="openSignatureCapture('sigCoach${team}_fiba', 'Team ${team} Coach')"><canvas class="sig-pad" id="sigCoach${team}_fiba" style="height:25px; pointer-events:none;"></canvas></div></div>
            `;
            box.innerHTML = html;
        }

        // Canvas drawing logic for the main popup pad
        let sigCtx = null;
        let isDrawing = false;
        let currentTargetCanvasId = null; // The ID of the inline canvas to map back to

        function initSigCaptureCanvas() {
            const canvas = document.getElementById('activeSigPad');
            sigCtx = canvas.getContext('2d');

            // Set responsive size based on container dynamically
            const resizeCanvas = () => {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                sigCtx.lineWidth = 4;
                sigCtx.lineCap = 'round';
                sigCtx.strokeStyle = '#000';
            };

            // Call once, and add event listener
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            function startPos(e) {
                isDrawing = true;
                draw(e);
            }
            function endPos() {
                isDrawing = false;
                sigCtx.beginPath();
            }
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const canvasRect = canvas.getBoundingClientRect();
                const x = clientX - canvasRect.left;
                const y = clientY - canvasRect.top;

                sigCtx.lineTo(x, y);
                sigCtx.stroke();
                sigCtx.beginPath();
                sigCtx.moveTo(x, y);
            }

            canvas.addEventListener('mousedown', startPos);
            canvas.addEventListener('mouseup', endPos);
            canvas.addEventListener('mousemove', draw);
            // Handle touch leaving canvas
            canvas.addEventListener('mouseleave', endPos);

            canvas.addEventListener('touchstart', startPos, { passive: false });
            canvas.addEventListener('touchend', endPos);
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchcancel', endPos);
        }

        function openSignatureCapture(targetCanvasId, roleName) {
            currentTargetCanvasId = targetCanvasId;
            document.getElementById('sigRoleTitle').innerText = `${roleName} Signature`;
            document.getElementById('sigCaptureModal').style.display = 'flex';

            // Ensure context is initialized
            if (!sigCtx) {
                initSigCaptureCanvas();
            } else {
                // Resize check on every open
                const canvas = document.getElementById('activeSigPad');
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                sigCtx.lineWidth = 4;
                sigCtx.lineCap = 'round';
            }

            clearSignature();
        }

        function closeSignatureCapture() {
            document.getElementById('sigCaptureModal').style.display = 'none';
        }

        function clearSignature() {
            if (sigCtx) {
                const canvas = document.getElementById('activeSigPad');
                sigCtx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function saveSignature() {
            if (!currentTargetCanvasId) return;

            const sourceCanvas = document.getElementById('activeSigPad');
            const targetCanvas = document.getElementById(currentTargetCanvasId);

            if (targetCanvas) {
                // Ensure target canvas dimensions match its visually rendered size
                const rect = targetCanvas.getBoundingClientRect();
                targetCanvas.width = rect.width * 2; // High-DPI support
                targetCanvas.height = rect.height * 2;

                const tCtx = targetCanvas.getContext('2d');
                tCtx.scale(2, 2);
                tCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
                // Draw the captured large signature scaled down into the inline canvas bounds
                tCtx.drawImage(sourceCanvas, 0, 0, sourceCanvas.width, sourceCanvas.height, 0, 0, rect.width, rect.height);
            }

            closeSignatureCapture();
        }

        // Prepare inline canvases with proper high-res setup, though they now only serve as display targets
        function setupInlineCanvases() {
            const pads = document.querySelectorAll('.sig-pad:not(#activeSigPad)');
            pads.forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                if (rect.width > 0 && rect.height > 0) {
                    canvas.width = rect.width * 2;
                    canvas.height = rect.height * 2;
                }
            });
        }

        // Setup inline canvases when they first become visible
        let inlineCanvasesSetup = false;

        // Boot
        // initRosters() will now be called by startMatch() from the setup UI.

        // --- SETUP LOGIC ---
        let draftRosterA = [];
        let draftRosterB = [];
        let draftPlayerIdCounter = 0;

        function addDraftPlayer() {
            const team = document.getElementById("draftTeamSelect").value;
            const number = document.getElementById("draftNumber").value;
            const nameStr = document.getElementById("draftName").value;

            if (!number) {
                alert("Please enter a jersey number.");
                return;
            }

            const p = { id: draftPlayerIdCounter++, number: number, name: nameStr || "Unknown", fouls: 0, pts: 0 };

            if (team === 'A') draftRosterA.push(p);
            else draftRosterB.push(p);

            document.getElementById("draftNumber").value = '';
            document.getElementById("draftName").value = '';
            renderDraftTables();
        }

        function removeDraftPlayer(team, id) {
            if (team === 'A') draftRosterA = draftRosterA.filter(p => p.id !== id);
            else draftRosterB = draftRosterB.filter(p => p.id !== id);
            renderDraftTables();
        }

        function renderDraftTables() {
            const tA = document.querySelector("#draftTableA tbody");
            const tB = document.querySelector("#draftTableB tbody");
            tA.innerHTML = ''; tB.innerHTML = '';

            draftRosterA.sort((a, b) => a.number - b.number).forEach(p => {
                tA.innerHTML += `<tr><td>${p.number}</td><td>${p.name}</td><td><button class="remove-draft-btn" onclick="removeDraftPlayer('A', ${p.id})">X</button></td></tr>`;
            });
            draftRosterB.sort((a, b) => a.number - b.number).forEach(p => {
                tB.innerHTML += `<tr><td>${p.number}</td><td>${p.name}</td><td><button class="remove-draft-btn" onclick="removeDraftPlayer('B', ${p.id})">X</button></td></tr>`;
            });
        }

        function startMatch() {
            // Setup Team Info
            state.teamA.name = document.getElementById("setupTeamA").value || "TEAM A";
            state.teamB.name = document.getElementById("setupTeamB").value || "TEAM B";
            state.teamA.coach = document.getElementById("setupCoachA").value || "";
            state.teamB.coach = document.getElementById("setupCoachB").value || "";
            state.teamA.asst = document.getElementById("setupAsstA").value || "";
            state.teamB.asst = document.getElementById("setupAsstB").value || "";

            document.getElementById("nameA").innerText = state.teamA.name;
            document.getElementById("nameB").innerText = state.teamB.name;

            // Setup Meta
            state.meta = {
                competition: document.getElementById("setupComp").value || "",
                date: document.getElementById("setupDate").value || "",
                time: document.getElementById("setupTime").value || "",
                gameNo: document.getElementById("setupGameNo").value || "",
                place: document.getElementById("setupPlace").value || "",
                referee: document.getElementById("setupRef").value || "",
                umpire1: document.getElementById("setupUmp1").value || "",
                umpire2: document.getElementById("setupUmp2").value || "",
                format: document.querySelector('input[name="sheetFormat"]:checked').value
            };

            // Inject Rosters
            if (draftRosterA.length === 0 && draftRosterB.length === 0) {
                // If they bypassed building a roster, fallback to generic 4-15
                for (let i = 4; i <= 15; i++) {
                    state.teamA.roster.push({ number: i, name: "", fouls: 0, pts: 0 });
                    state.teamB.roster.push({ number: i, name: "", fouls: 0, pts: 0 });
                }
            } else {
                state.teamA.roster = [...draftRosterA];
                state.teamB.roster = [...draftRosterB];
            }

            renderRosters();

            // Hide Setup, Show App
            document.getElementById("setupPhase").style.display = 'none';
            document.getElementById("mainApp").style.display = 'flex';
        }

        // Initialize draft tables visually empty
        renderDraftTables();

    </script>
</body>

</html>