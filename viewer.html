<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CourtStream – Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --bg:#0f1115;
  --panel:#161922;
  --border:#262b3d;
  --text:#e6e6eb;
  --muted:#9aa0b4;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
  height:100vh;
}

/* ===== LAYOUT ===== */
.viewer{
  display:flex;
  flex-direction:column;
  height:100%;
  padding:14px;
  gap:14px;
}

/* ===== PLAYER ===== */
.player{
  position:relative;
  flex:1;
  background:#000;
  border-radius:16px;
  border:1px solid var(--border);
  overflow:hidden;
}

.player::before{
  content:"";
  display:block;
  padding-top:56.25%;
}

.player video{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  background:#000;
}

.stream-badge{
  position:absolute;
  top:14px;
  left:14px;
  background:rgba(15,17,21,.85);
  border:1px solid var(--border);
  padding:6px 12px;
  border-radius:999px;
  font-size:13px;
}

.live-badge{
  position:absolute;
  top:14px;
  right:14px;
  background:rgba(15,17,21,.85);
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  color:#22c55e;
}

.controls{
  position:absolute;
  bottom:14px;
  right:14px;
  display:flex;
  gap:8px;
}

.ctrl-btn{
  border:none;
  background:rgba(15,17,21,.85);
  border:1px solid var(--border);
  color:#fff;
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
}
</style>
</head>

<body>

<div class="viewer">
  <div class="player">
    <video id="v" autoplay muted playsinline></video>

    <div class="stream-badge" id="streamBadge">CourtStream • LIVE</div>
    <div class="live-badge">LIVE</div>

    <div class="controls">
      <button class="ctrl-btn" onclick="toggleFullscreen()">Fullscreen</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const params = new URLSearchParams(location.search);
const streamId = params.get("stream");
const streamName = params.get("name");
const video = document.getElementById("v");
const badge = document.getElementById("streamBadge");
let directorId = null;

async function updateStreamBadge(){
  let name = streamName;

  if (!name && streamId) {
    try {
      const res = await fetch("/api/streams");
      if (res.ok) {
        const streams = await res.json();
        const match = streams.find(s => s.id === streamId);
        if (match) name = match.name;
      }
    } catch {
      // fallback below
    }
  }

  const label = name || streamId || "CourtStream";
  badge.innerText = `${label} • LIVE`;
}
updateStreamBadge();

function toggleFullscreen(){
  const el = document.querySelector(".player");
  if (!document.fullscreenElement) {
    el.requestFullscreen?.();
  } else {
    document.exitFullscreen?.();
  }
}

/* ===== WEBRTC ===== */
const socket = io();
const pc = new RTCPeerConnection({
  iceServers: [
    {
      urls: [
        "stun:stun.cloudflare.com:3478",
        "stun:stun.cloudflare.com:53"
      ]
    },
    {
      urls: [
        "turn:turn.cloudflare.com:3478?transport=udp",
        "turn:turn.cloudflare.com:3478?transport=tcp",
        "turns:turn.cloudflare.com:5349?transport=tcp",
        "turn:turn.cloudflare.com:53?transport=udp",
        "turn:turn.cloudflare.com:80?transport=tcp",
        "turns:turn.cloudflare.com:443?transport=tcp"
      ],
      username: "g07ef1b745ad2a747da14d563e4bfbd538f21945297c2fad25578fb243c68286",
      credential: "3882b29cc1772be95d469efdb14ccd45ed1b79ec8c52d9e0d8070720e093b43d"
    }
  ]
});

socket.emit("join", { room: streamId, role: "viewer" });
socket.emit("viewer-ready", { room: streamId });

pc.ontrack = e => {
  video.srcObject = e.streams[0];
  video.muted = true;
  video.onloadedmetadata = () => video.play().catch(()=>{});
};

pc.onicecandidate = e => {
  if (e.candidate && directorId) {
    socket.emit("signal", { to: directorId, data: e.candidate });
  }
};

socket.on("signal", async ({from,data})=>{
  if (!data) return;

  if (data.type === "offer") {
    directorId = from;
    await pc.setRemoteDescription(data);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    socket.emit("signal",{to:from,data:pc.localDescription});
    return;
  }

  const candidateInit = data.candidate !== undefined ? data.candidate : data;
  if (!candidateInit) return;
  if (typeof candidateInit !== "object") return;
  if (!candidateInit.candidate && !candidateInit.sdpMid && !candidateInit.sdpMLineIndex) return;
  await pc.addIceCandidate(candidateInit);
});
</script>
</body>
</html>
